<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Вход</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-4">
        <h1 class="mb-4">Вход</h1>
        <form method="POST" action="/login" class="mb-3">
            <input type="text" name="username" class="form-control mb-2" placeholder="Имя пользователя" required>
            <input type="password" name="password" class="form-control mb-2" placeholder="Пароль" required>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Войти</button>
                <a href="/register" class="btn btn-success">Регистрация</a>
            </div>
        </form>
        <div id="error-message" class="text-danger mb-2" style="display:none;">
            <!-- Здесь будет выводиться ошибка -->
        </div>
        <div id="forgot-btn" style="display:none;">
            <a href="/forgot" class="btn btn-warning">Восстановить пароль</a>
        </div>
    </div>
    <script>
        const params = new URLSearchParams(window.location.search);
        const error = params.get('error');
        if (error) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = error;
            errorDiv.style.display = 'block';
            document.getElementById('forgot-btn').style.display = 'block';
        }
    </script>
</body>
</html>
<script>
    import bcrypt from 'bcryptjs';

    (async () => {
        const passwordHash = await bcrypt.hash('1234', 10);
        db.run(
            'DELETE FROM users WHERE username = ?',
            ['Anastasia'],
            () => {
                db.run(
                    'INSERT INTO users (username, passwordHash, role) VALUES (?, ?, ?)',

                    ['Anastasia', passwordHash, 'admin'],
                    (err) => {
                        if (err) console.error('Ошибка добавления пользователя:', err.message);
                        else console.log('Пользователь Anastasia добавлен как админ');
                    }
                );
            }
        );
    })();

    db.run(
        'UPDATE users SET role = ? WHERE username = ?',
        ['admin', 'Anastasia'],
        (err) => {
            if (err) console.error('Ошибка обновления роли:', err.message);
            else console.log('Роль администратора назначена пользователю Anastasia');
        }
    );

    function requireAdmin(req: express.Request, res: express.Response, next: express.NextFunction) {
        if (req.session.role !== 'admin') {
            return res.status(403).send('Доступ разрешён только администраторам');
        }
        next();
    }

    // Пример кода для установки роли в сессии при успешном входе
    app.post('/login', (req, res) => {
        const { username, password } = req.body;
        db.get('SELECT * FROM users WHERE username = ?', [username], (err, row) => {
            if (err) {
                return res.status(500).send('Ошибка базы данных');
            }
            if (!row) {
                return res.status(401).send('Неверное имя пользователя или пароль');
            }
            bcrypt.compare(password, row.passwordHash, (err, result) => {
                if (err) {
                    return res.status(500).send('Ошибка при проверке пароля');
                }
                if (!result) {
                    return res.status(401).send('Неверное имя пользователя или пароль');
                }
                // Успешный вход, установка роли в сессии
                req.session.role = row.role;
                res.send('Успешный вход');
            });
        });
    });

    db.get('SELECT * FROM users WHERE username = ?', ['Anastasia'], (err, row) => {
        console.log(row);
    });

    app.get('/', requireAuth, (req, res) => {
        res.sendFile(path.join(__dirname, '../public/index.html'));
    });

    app.use((req, res, next) => {
        const publicPaths = ['/login', '/register', '/forgot'];
        if (publicPaths.includes(req.path) || req.path.startsWith('/static')) {
            return next();
        }
        if (!req.session.user) {
            return res.redirect('/login');
        }
        next();
    });
</script>